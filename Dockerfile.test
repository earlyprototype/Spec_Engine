# Lightweight test container for running integration tests
FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements files
COPY setup.py .
COPY pattern_extraction_pipeline/requirements.txt pattern_extraction_pipeline/
COPY ide_rule_library/requirements.txt ide_rule_library/

# Install Python dependencies
RUN pip install --no-cache-dir -e . && \
    pip install --no-cache-dir -r pattern_extraction_pipeline/requirements.txt && \
    pip install --no-cache-dir -r ide_rule_library/requirements.txt && \
    pip install --no-cache-dir pytest pytest-cov pyyaml

# Copy source code
COPY pattern_extraction_pipeline pattern_extraction_pipeline/
COPY ide_rule_library ide_rule_library/

# Set Python path
ENV PYTHONPATH=/app:$PYTHONPATH

# Default command (can be overridden in docker-compose)
CMD ["pytest", "pattern_extraction_pipeline/tests/", "-v"]
