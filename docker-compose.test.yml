version: '3.8'

services:
  neo4j:
    image: neo4j:5.15
    container_name: neo4j-test
    environment:
      NEO4J_AUTH: neo4j/testpassword
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_memory_pagecache_size: 512M
      NEO4J_dbms_memory_heap_initial__size: 512M
      NEO4J_dbms_memory_heap_max__size: 1G
    ports:
      - "7687:7687"
      - "7474:7474"
    healthcheck:
      test: ["CMD-SHELL", "wget -O /dev/null -q http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    volumes:
      - neo4j-test-data:/data
    networks:
      - test-network

  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: test-runner
    depends_on:
      neo4j:
        condition: service_healthy
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: testpassword
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      PYTHONUNBUFFERED: 1
    command: >
      sh -c "
      echo 'Waiting for Neo4j to be fully ready...' &&
      sleep 5 &&
      echo 'Running tests...' &&
      pytest pattern_extraction_pipeline/tests/ -v --tb=short --color=yes
      "
    networks:
      - test-network
    volumes:
      - ./pattern_extraction_pipeline:/app/pattern_extraction_pipeline
      - ./ide_rule_library:/app/ide_rule_library

volumes:
  neo4j-test-data:

networks:
  test-network:
    driver: bridge
